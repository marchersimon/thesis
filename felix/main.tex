\setchapterstyle{kao}
\setchapterpreamble[u]{\margintoc}

\setcounter{chapter}{19}

\chapter{The MIDI Protocol}
\labch{mi-midi-protocol}

\section{What is MIDI}

\subsection{General information about MIDI}

Musical Instrument Digital Interface short MIDI is a protocol for exchanging musical events between devices like synthesizer, keyboards or electrical drums. The first MIDI protocol, MIDI 1.0, appeared 1982. Dave Smith with the cooperation of Ikutaro Kakehashi, developed MIDI. 2013 they were awarded the technical Grammy. Today we use MIDI 2.0.

\subsection{Live MIDI ver MIDI Files}

Live MIDI is like a USB connection just another protocol and another cable. MIDI files have all the events in one file and you can play it anywhere if you have the right program.

\begin{center}
\begin{tabular}{@{}cc@{}}
\toprule
\multicolumn{2}{c}{Differences}             \\\midrule
Live MIDI            & MIDI File            \\
cable                & file                 \\
no delta Time        & delta Time           \\\bottomrule
\end{tabular}
\end{center}
\phantom{Hello}

\section{Why use MIDI}

We used MIDI because it is the easiest to convert to PWM signals. MIDI is also much smaller than MP3 and WAV so it is perfect for micro-controllers which only have little storage space.  

\section{MIDI File}

MIDI files are Binary files. A MIDI file consists of chunks. A chunk begins with 4 ASCII characters after that follow 32 Bit which give the number of bytes in a chunk. MIDI files begin with a header chunk. After the header chunk can be one track chunk or more. The 4 ASCII characters for a header chunk are \textbf{MThd} and for track chunks it is \textbf{MTrk}.

\subsection{Header Chunk}

A header chunk can looks like this.

\begin{tabular}{llll|llll|ll|ll|ll}
\hline
4D & 54 & 68 & 64 & 00     & 00     & 00     & 06     & 00           & 00          & 00                                        & 01                                        & 01            & E0           \\ \hline
M  & T  & h  & d  & \multicolumn{4}{l}{Header Length} & \multicolumn{2}{l}{format} & \multicolumn{2}{l}{\begin{tabular}[c]{|@{}l@{}|}number of \\ track chunks\end{tabular}} & \multicolumn{2}{l}{division}
\end{tabular}

MThd are the four ASCII characters that define, that this is a header chunk. The next four bytes are the header length. The length is always six bytes long. Next two bytes are format, which can be 0 for single track format, 1 for multiple track format and 2 for multiple song format. Currently we only can play \textbf{single track format}. The 2 bytes after the format are the number of track chunks that come after the header chunk because we currently can only play \textbf{single track format} the program can not play more than 1 track chunk. The last two bytes are the division.

\subsection{Track Chunk}

The track chunks begins like the header chunk with 4 ASCII characters which are \textbf{MTrk}. After the 4 characters comes the 4 bytes long length. The length indicates how many bytes are in the track chunk. At last comes the \textbf{track event}.

\subsubsection{Track event}

A track event starts with the \textbf{delta time}. The delta time is the time between one event to the next event. Then comes which type of event it is. There can be three different event types, \textbf{MIDI event}, \textbf{META event} and \textbf{SYSEX event}. We never needed the \textbf{SYSEX event} so there will not be an explanation for it. If the event type is a META event it begins with 0xFF after that comes which META event it is. Then the length of the META event data. At the end comes the META event data. For example if you have a Track event which is META event for instance \textbf{Set Tempo} and a delta time of 0 and the tempo in set tempo is 666667 microseconds per quarter note. It would look like this.

\begin{table}
\centering
\begin{tabular}{|llll|llll|c|lll|lll|}
0x4D & 0x54 & 0x72 & 0x6B    & 0x00 & 0x00 & 0x02 & 0x22      & 0x00       & 0xFF & 0x51 & 0x03             & 0x0A & 0x2C & 0x2B           \\ 
\hline
\multicolumn{4}{|c|}{MTrk}   & \multicolumn{4}{c|}{546 bytes} & delta Time & \multicolumn{3}{c|}{Set Tempo} & \multicolumn{3}{c|}{666667} 
\end{tabular}
\end{table}

\phantom{Simon hilfe das steht nicht da wo es sein soll das ist so ein dreck}

\chapter{Programming the Interrupter}

\section{Choice of Hardware}