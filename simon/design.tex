\setchapterstyle{kao}
\setchapterpreamble[u]{\margintoc}

\chapter{Design and Simulation} % How I thought it was going to work
\labch{tc-design-and-simulation}

\textbf{Disclaimer:} This process was a lot more length and tedious than depicted in the following chapter. It mostly consisted of trial and error, which started with an more or less educated guess and ended in cluelessness and despair. But those errors don't add a lot of value to understanding the topic, so I won't go into much detail.

\section{The Coils}

The goal was to design an air coil with a resonant frequency of 4MHz. This frequency was chosen, since it is high enough to work well with an class E amplifier, but low enough to not run into too many RF related problems. It was also already known to have worked with a few other class E tesla coils.

\subsection{Rough Estimation of the Secondary Coil}

The inductance of a single-layered air solenoid coil can be calculated with

\begin{equation}\label{eq-inductivity}
    L = \mu_0 \frac{N^2 A}{l}
\end{equation}

The parasitic capacitance, depending on its length \(l\) and its diameter \(D\) can be calculated with\sidecite{self-capacitance}

\begin{equation}\label{eq-parasitic-capacitance}
    C_L = \frac{4\varepsilon_0}{\pi} \cdot l \cdot \left( 1 + 0.8249 \frac{D}{l} + 2.329 \left(\frac{D}{l}\right)^{1.5}\right)
\end{equation}

Defining the length to diameter ratio of the coil to be 4, and \(d_w\) to be the diameter of the wire, both formulas can be rewritten to only depend on \(l\) and \(d_w\). 

\begin{equation}
    L = \mu_0 \frac{l^3\ \pi}{32 d_w^2}
\end{equation}

\begin{equation}
    C_L = \frac{4\varepsilon_0}{\pi} \cdot l \cdot 1.49735
\end{equation}

Those equations can then be set into the formula for the resonant frequency of an LC circuit.

\begin{equation}
    f = \frac{1}{2\pi \cdot \sqrt{0.1872 \cdot \dfrac{1}{d_w^2} \cdot \mu_0 \varepsilon_0 \cdot l^4}}
\end{equation}

Rearranging the equation to \(l\)

\begin{equation}
    l = \frac{1}{\sqrt[\scalebox{1}{4}]{4\pi^2 f^2 \cdot0.1872 \cdot \dfrac{1}{d_w^2} \cdot \mu_0 \varepsilon_0}}
\end{equation}

With a frequency of 4MHz and a wire diameter of 0.35mm, the length of the coil turns out to be around 100mm and the diameter therefore around 25mm.

Due to the materials available, a 30 mm tube was used to wind the wire around. By using equation \ref{eq-inductivity} and \ref{eq-parasitic-capacitance}, an equation can be derived, which describes the relationship of all relevant variables.

\begin{equation}
    f = \frac{1}{2\pi \dfrac{D}{d_w} \sqrt{\mu_0 \varepsilon_0 \left( l^2 + 0.8245 D l + 2.329 D^{1.5} \sqrt{l} \right)}}
\end{equation}

Using Wolfram Alpha to solve this equation for \(l\) with a \(D\) of 30 mm gives a length of 112 mm.
% 4000000 = 1/(2Ï€(0.03/0.00035)Sqrt[11.1265e-18*(Power[x,2]+0.8245*0.03*x+2.329*Power[0.03,1.5]*Sqrt[x])]) solve for x

\subsection{Tuning the Secondary Coil}\label{TC-tuningTheSecondary}

Tuning the coil to the correct frequency is essential, because all calculated values from above are highly idealized. For example, equation \ref{eq-parasitic-capacitance} is said to have a standard deviation of \(\sigma_{CL} \text{in pF} = 3.6 \cdot D\), which leads to a standard deviation of around 116 kHz of the resonant frequency of the coil. In addition, the relative permeability and permittivity factor of the carrier material are not taken into consideration in the calculations.

The coil was tuned by exciting the base of the secondary coil with a sinusoidal voltage. An oscilloscope probe, formed into a current loop, was placed near the top of the coil. The closer the excitation frequency was to the resonant frequency of the coil, the higher the measured voltage on the oscilloscope. The frequency, at which the measured voltage was at its maximum, was the resonant frequency of the coil. By adding or removing windings, the resonant frequency could be lowered or raised, until it exactly matched 4MHz\sidenote{In order to avoid adding windings, which is more tedious than removing them, the coil was wound a little longer than calculated}. % Add how close the original calculations were

\subsection{Designing the Primary Coil}
\label{sec:designing-the-primary}

The primary coil offers a lot of design freedom and flexibility, but this also means, that there is no \enquote{correct} or \enquote{ideal} design, but only one, which has been observed to work well. It mostly comes down to optimizing the coupling coefficient between the two coils. If it's too low, not enough energy will be transferred to the secondary, but to raise it, the coils have to be moved closer together which leads to flashover, due to too low insulation. % Test tesla coil with coupling factor of 0.10 to 0.15  Source: book page 55
This limitation can be bypassed by making the primary coil smaller at the bottom, where the voltage is higher and larger at the top, where the voltage is higher. This results in the well-known conical shape known from many tesla coils.

\begin{marginfigure}
\centering
\includegraphics[width=0.6\textwidth]{simon/resources/teslaCoilSketch.png}
\end{marginfigure}

\subsection{Simulating the Coupling Coefficient}

In order to simulate the resonant transformer, its coupling coefficient has to be known. It describes how tightly the two coils are magnetically coupled and how much of the generated magnetic field of one coil is induced in the other. The simulation tool EleFAnT2D\sidenote{\textbf{Ele}ctromagnetic \textbf{F}ield \textbf{An}alyis \textbf{T}ool, developed IGTE, TU Graz} was used to simulate the magnetic flux in the system. The coupling coefficient can be described as

\begin{equation}
    k = \frac{\Phi_{ind}}{\sqrt{\Phi_P \cdot \Phi_S}}
\end{equation}

where \(\Phi_{ind}\) is the flux linkage between the two coils and \(\Phi_P\) and \(\Phi_S\) are the flux of the primary and secondary coil, respectively.\todo{Is it really?} By using this formula and the simulated values, the coupling factor as a function of the vertical displacement of the primary coil has been calculated as can be seen in figure \ref{fig:coupling-factor}.

\begin{figure}[h!]
    \centering
    \begin{tikzpicture}
    \begin{axis}[
    width = 0.9\textwidth,
    minor tick num = 1,
    grid = both,
    ymax = 25,
    xmin = -20,
    xmax = 20,
    xlabel = Vertical displacement in mm,
    ylabel = Coupling factor in \%
    ]
    \addplot+[mark options={black!50}, draw=black] table [x=d, y=k, col sep=comma]{simon/resources/couplingFactor.csv};
    \draw (axis cs:0,-10) -- (axis cs:0,18.397) -- (axis cs:-20,18.397);
    \draw (axis cs:-18,18.9) node(){\(18.4\)};
    \end{axis}
    \end{tikzpicture}
    \caption{Position dependent coupling factor}
    \label{fig:coupling-factor}
\end{figure}

As expected, the coupling factor gets smaller the farther away the primary coil moves from the middle of the secondary coil.

\section{The Class-E Stage}

As already explained in aaaaa, it is everything but trivial to design a class E amplifier to drive a tesla resonator. However, for the sake of demonstration, the following subsection will go through the design process of a class E amplifier with an ohmic load.

\subsection{The Design Process}

Nathan Sokal, who popularized the class-E amplifier along with Alan Sokal, presented a set of revised design equations in 2001 \sidecite[-3mm]{sokal-qex}. Unlike previously published equations, they include the dependence of the loaded Q factor\sidenote{It describes how damped a resonator is, or in other words, how quickly it dissipates its oscillating energy.} as well as on the output power.

The goal of this amplifier is to create 50\,W of output power in a load of 22\,\(\Omega\) at a frequency of 4\,MHz. The Q factor of the load network has to be chosen by the designer and involves 

\begin{displayquote}
\enquote{a trade-off among the operating bandwidth (wider with lower \(Q_L\)), harmonic content of the output power (\textelp{} lower with higher \(Q_L\)) and power loss in the parasitic resistances of the load-network inductor \(L_2\) and capacitor \(C_2\) (lower with lower \(Q_L\)).}
\end{displayquote}

The chosen value for \(Q_L\) is 5, because it is a common starting value for simple class-E amplifiers. The switching device will be a MOSFET, so the saturation voltage used in the equations have already been set to zero. Also, to make the calculations clearer, all numbers, as well as the results have been rounded to three significant digits. The necessary supply voltage is

\begin{equation*}
    V_{CC} = \sqrt{R \cdot P \cdot 1.73 \cdot \frac{1}{1 - \frac{0.452}{Q_L} - \frac{0.402}{Q_L^2}}} = 46.1\,V\textnormal{\,.}
\end{equation*}

The expected peak drain-source voltage on the MOSFET is 3.56 times the supply voltage plus a safety factor of around 20\%, which means that the MOSFET has to have a drain-source breakdown voltage of at least 197\,V. 

The choke inductance \(L_1\), again, has to be chosen in order to calculate the remaining component values. It has to be big enough to force enough current into \(C_1\) and keep the current ripple low. A rule of thumb is that \(X_{L1}\) should be at least 30 times greater than \(X_{C1}\). However, since \(C_1\) slightly depends on \(L_1\), this is an iterative process. A value for \(L_1\), which turns out to work well is \(130\,\mu H\). \(C_1\), \(C_2\), and \(L_2\) can then be calculated with

\begin{equation*}
    C_{1t} = \frac{1}{34.2\cdot f R} \cdot \left( 1 + \frac{0.914}{Q_L} - \frac{1.03}{Q_L^2} \right) + \frac{0.6}{(2 \pi f)^2  \cdot L_1} = 387\,pF\textnormal{\,,}
\end{equation*}
\begin{equation*}
    C_2 = \frac{1}{2 \pi  f  R} \cdot \frac{1}{Q_L - 0.105} \cdot \left( 1 + \frac{1.01}{Q_L - 1.79} \right) - \frac{0.2}{(2 \pi f)^2 \cdot L_1} = 482\,pF \textnormal{\,, and}
\end{equation*}
\begin{equation*}
    L_2 = \frac{Q_L \cdot R}{2 \pi f} = 4.38\,\mu H\textnormal{\,.}
\end{equation*}
 
Since \(C_1\) is the sum of the capacitor \(C_{1*}\) and the MOSFET's output capacitance \(C_{1_M}\), % better convention?
this output capacitance cannot be greater than \(C_1\) itself.

Based on the previous calculations, the MOSFET must have

\begin{itemize}
    \item a drain-source breakdown voltage greater than 197\,V,
    \item an output capacitance less than 387\,pF,
    \item switching times much smaller than 125\,ns (\nicefrac{T}{2}), and
    \item a maximum power dissipation of at least 5\,W.
\end{itemize}

One MOSFET which meets all these criteria is the BSC12DN20NS3. It has a drain-source breakdown voltage of 200V, an output capacitance of 39pF, turn-off and turn-on times of less than 5 ns and a maximum power dissipation of 50W. The capacitor \(C_{1*}\) therefore is \(387\,pF - 39\,pF = 348\,pF\).

The driver was then simulated using the analog electronic circuit simulator LTSpice. The LTSpice model for the BSC12DN20NS3 can be found with \newqrcode{https://www.infineon.com/dgdl/Infineon-PowerMOSFET_OptiMOS_PSpice_200V_N-Channel-SimulationModels-v02_00-EN.zip?fileId=5546d4624f72be57014f73c9c774060e}. This zip file contains a file called \enquote{OptiMOS3\_200V\_LTSpice.lib}, which contains multiple MOSFET models. To include the MOSFET into the schematic, a standard \enquote{nmos} has to be added. By Ctrl-right clicking it, \enquote{BSC12DN20NS3\_L1} can be inserted into the \enquote{value} field. The \enquote{L1} means, that switching losses will be simulated.

Figure \ref{fig:class-e-res} shows the MOSFET waveforms after \(20\,\mu s\), when a steady state has been reached. 

\begin{figure}
    \centering
    \begin{tikzpicture}
      \begin{axis}[
        xmin = -74,
        xmax = 426,
        ymin = -50,
        ymax = 180,
        grid = both,
        xtick distance = 125,
        width = \textwidth,
        axis y line* = left,
        xticklabel shift=1mm,
        xlabel = \(t\) in \(ns\),
        ylabel = \(V_{DS}\) in \(V\),
        scaled ticks = false,
        x filter/.code=\pgfmathparse{#1 * 1000000000 - 74},
        ]
        \addplot+[draw=red] table [x=t, y=v, col sep=comma, mark=none]{simon/resources/classe_res_mosfet.csv};
        \coordinate (magn) at (axis cs:125,100);
        \draw[black!25, dashed] (axis cs:115,-9) rectangle (axis cs:160,15);
        \draw[black!25, dashed] (axis cs:115,15) -- (axis cs:125,100);
        \draw[black!25, dashed] (axis cs:160,15) -- (axis cs:250,100);
        \node[left, red!30!black] at (axis cs:20,110) {\(V_{DS}\)};
      \end{axis}
      %\spy [blue, dotted, size=5cm] on (spypoint) in node[fill=white] at (magnifyglass);
      \begin{axis}[
        xmin = -74,
        xmax = 426,
        ymax = 9,
        ymin = -2.5,
        xtick = {-125},
        width = \textwidth,
        axis y line* = right,
        ylabel = \(I_D\) in \(A\),
        x filter/.code=\pgfmathparse{#1 * 1000000000 - 74},
        ]
        \addplot+[draw=blue!75] table [x=t, y=i, col sep=comma, mark=none]{simon/resources/classe_res_mosfet.csv};
        \node[above, blue!30!black] at (axis cs:-35,2.9) {\(I_D\)};
      \end{axis}
      \begin{axis}[
        xmin = 115,
        xmax = 160,
        ymin = -9,
        ymax = 15,
        ytick = {0,7.24},
        xtick = {125},
        ticklabel style={font=\scriptsize},
        grid = major,
        x filter/.code=\pgfmathparse{#1 * 1000000000 - 74},
        shift={(magn)},
        axis background/.style={fill=white},
        width=0.361\textwidth,
        height=0.303\textwidth,
        ]
        \addplot+[draw=red] table [x=t, y=v, col sep=comma, mark=none]{simon/resources/classe_res_mosfet.csv};
      \end{axis}
      \draw[fill=black!20] (0,0) rectangle (1.35,-.1);
      \draw[fill=black!40] (1.35,0) rectangle (3.627,-.1);
      \draw[fill=black!20] (3.627,0) rectangle (5.91,-.1);
      \draw[fill=black!40] (5.91,0) rectangle (8.187,-.1);
      \draw[fill=black!20] (8.187,0) rectangle (9.12,-.1);
      \node[font=\tiny] at (2.49,-.3) {OFF};
      \node[font=\tiny] at (4.77,-.3) {ON};
      \node[font=\tiny] at (7,-.3) {OFF};
    \end{tikzpicture}
    \caption{Voltage across and current through the MOSFET}
    \label{fig:class-e-res}
\end{figure}

\section{The Interrupter}

\subsection{Fiber Optic Receiver}

\subsection{MOSFET protection circuit}

Directly applying the interrupting technique to the class E circuit by just turning it on and off at any given moment would violate both the \gls{zvs} and \gls{zcs} conditions. In the worst case, switching the MOSFET on when the voltage is at its maximum and turning it off when the current is at its maximum a few thousand times a second would result in huge switching losses and device failure. Therefore a security mechanism has to be implemented.

One solution is to sample the interrupter signal and only apply it on every falling edge of the 4MHz base signal. The sampling could be done with a falling-edge triggered D-type flip-flop, whose output gets fed into an AND gate along with the base signal.

\begin{figure}[h!]
    \centering
    \caption{Bottom side text}
    \begin{circuitikz}[european]
      \draw (0,0) node[flipflop, flipflop def = {t1 = D, c3 = 1, n3 = 1, t3 = CLK, t6 = Q}](D){};
      \draw (4,.61) node[and port](A){};
      \draw (D.pin 6) -- (A.bin 1);
      \draw (D.pin 1) node[left]{INT};
      \draw (D.pin 3) ++(-.5,0) node[left]{4MHz} -- (D.pin 3);
      \draw (D.pin 3) ++(-.25,0) to[short, *-] ++(0,-.8) -- ++(3,0) node(n1){} -- (n1 |- A.bin 2) -- (A.bin 2);
      \draw (A.bout) ++(.4,0) node[right]{OUT};
    \end{circuitikz}
    \phantom{a}
    \vspace{10mm}
    \phantom{a}
    \begin{tikztimingtable}[timing/xunit = 5mm, timing/slope = 0.05]
      4MHz & 3{2{l}2{h}} N(a) 4{2{l}2{h}} N(b) 2{2{l}2{h}} \\
      INT  & 11{h} 16{l} 9{h} \\
      Q    & 12{h}16{l} 8{h} \\
      OUT  & 3{2{l}2{h}}16{l}2{2{l}2{h}} \\
      \extracode
      \draw[dotted, darkgray] (a) -- ++(0,-6);
      \draw[dotted, darkgray] (b) -- ++(0,-7);
    \end{tikztimingtable}
\end{figure}